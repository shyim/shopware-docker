#!/usr/bin/env bash

FILE="$0"

if [ -L "$0" ]; then
  FILE=$(readlink "$0")
fi

DIR=$(dirname $FILE)
SHOPWARE_PROJECT="$2"
FIXTURE_NAME="$3"
SNAP_SUFFIX="$3"
SNAP_DIR="$HOME/Code/snapshots"
SHOPWARE_FOLDER="$HOME/Code/$SHOPWARE_PROJECT"

if [ ! -z "$SNAP_SUFFIX" ]; then
    SNAP_SUFFIX=$(echo "-${SNAP_SUFFIX}")
fi

# Need to be in docker folder for docker-compose
cd ${DIR}

function fixHooks()
{
    rm ${SHOPWARE_FOLDER}/.git/hooks/pre-commit
    ln -s ${SHOPWARE_FOLDER}/build/gitHooks/pre-commit ${SHOPWARE_FOLDER}/.git/hooks/pre-commit
    echo "Hooks fixed"
}

function clearCache()
{
    rm -r ${SHOPWARE_FOLDER}/var/cache/production_*
    rm -r ${SHOPWARE_FOLDER}/var/cache/testing_*
    rm -r ${SHOPWARE_FOLDER}/var/cache/docker_*
}

function fixDeveloperConfig()
{
    php ${DIR}/utils/fix-config.php "$SHOPWARE_FOLDER/config.php" $1
}

function checkParameter()
{
    if [ -z "$SHOPWARE_PROJECT" ]; then
        echo "Please enter a shopware folder name"
        exit 1
    fi

    if [ ! -d "$SHOPWARE_FOLDER" ]; then
        echo "Folder $SHOPWARE_FOLDER does not exists!"
        exit 1
    fi
}

function applyFixture()
{
  if [ -z "$FIXTURE_NAME" ]; then
    echo "Please enter a fixture name"
    exit 1
  fi

  if [ ! -e "${DIR}/fixtures/${FIXTURE_NAME}.sql" ]; then
    echo "Fixture by name ${FIXTURE_NAME} does not exist"
    exit 1
  fi
  docker-compose run --rm cli mysql -h mysql -u root -proot $SHOPWARE_PROJECT < "${DIR}/fixtures/${FIXTURE_NAME}.sql"
}

function isComposerProject()
{
    if [ -d "$SHOPWARE_FOLDER/app" ]; then
        echo "true"
    fi
}

function buildComposerProjectEnvFile()
{
  echo "SHOPWARE_VERSION_TEXT=\"$SHOPWARE_PROJECT (local docker)\"" >> "$SHOPWARE_FOLDER/.env"
  echo "SHOPWARE_REVISION=\"`git rev-parse HEAD`\"" >> "$SHOPWARE_FOLDER/.env"
  echo "DATABASE_URL=\"mysql://root:root@mysql:3306/$SHOPWARE_PROJECT\"" >> "$SHOPWARE_FOLDER/.env"
  echo 'ADMIN_EMAIL="demo@demo.com"' >> "$SHOPWARE_FOLDER/.env"
  echo 'ADMIN_NAME="Don Joe"' >> "$SHOPWARE_FOLDER/.env"
  echo 'ADMIN_USERNAME="demo"' >> "$SHOPWARE_FOLDER/.env"
  echo 'ADMIN_PASSWORD="demo"' >> "$SHOPWARE_FOLDER/.env"
  echo "SHOP_URL=\"http://$SHOPWARE_PROJECT.dev.localhost\"" >> "$SHOPWARE_FOLDER/.env"
  echo 'IMPORT_DEMODATA=y' >> "$SHOPWARE_FOLDER/.env"
}

case "$1" in
  build)
    checkParameter
    clearCache
    if [ `isComposerProject` ]; then
      docker-compose run --rm cli mysql -h mysql -u root -proot -e "CREATE DATABASE IF NOT EXISTS $SHOPWARE_PROJECT"
      docker-compose run --rm -w "/var/www/html/${SHOPWARE_PROJECT}" cli bash -c "composer install"
      buildComposerProjectEnvFile
      docker-compose run --rm cli bash -c "/var/www/html/${SHOPWARE_PROJECT}/app/install.sh"      
    else
      docker-compose run --rm -eANT_OPTS=-D"file.encoding=UTF-8" cli ant -Dapp.host=$SHOPWARE_PROJECT.dev.localhost -Ddb.host=mysql -Ddb.user=root -Ddb.password=root -Ddb.name=$SHOPWARE_PROJECT -f /var/www/html/$SHOPWARE_PROJECT/build/build.xml build-unit
      fixHooks
      fixDeveloperConfig
    fi
    ;;
  test)
    checkParameter
    clearCache
    docker-compose run --rm -eANT_OPTS=-D"file.encoding=UTF-8" cli ant -Dapp.host=$SHOPWARE_PROJECT.dev.localhost -Ddb.host=mysql -Ddb.user=root -Ddb.password=root -Ddb.name=$SHOPWARE_PROJECT -f /var/www/html/$SHOPWARE_PROJECT/build/build.xml build-unit unit-shopware-continuous
    fixHooks
    ;;
  drop)
    checkParameter
    docker-compose run --rm cli mysql -h mysql -u root -proot -e "DROP DATABASE $SHOPWARE_PROJECT"
    ;;
  shell)
    docker-compose run -e COLUMNS="`tput cols`" -e LINES="`tput lines`" -e SHELL=bash --rm cli bash
    ;;
  snippets)
    checkParameter
    docker-compose run -e COLUMNS="`tput cols`" -e LINES="`tput lines`" --rm cli php /var/www/html/${SHOPWARE_PROJECT}/bin/console sw:snippets:to:db --include-plugins
    clearCache
    ;;
  hooks)
    checkParameter
      fixHooks
      ;;
  config)
    checkParameter
    fixDeveloperConfig "$3"
    ;;
  up)
    docker-compose up -d
    ;;
  down)
    docker-compose down
    ;;
  new-ticket)
    SHOPWARE_FOLDER=$(echo "${SHOPWARE_FOLDER/-/}")
    SHOPWARE_PROJECT=$(echo "${SHOPWARE_PROJECT/-/}")
    git clone ssh://git@stash.shopware.com/sw/shopware.git ${SHOPWARE_FOLDER}
    if [ ! -d "$SHOPWARE_FOLDER" ]; then
        echo "Git checkout failed"
        exit 1
    fi
    cd ${SHOPWARE_FOLDER}
    git checkout 5.5
    git checkout -b ${SHOPWARE_PROJECT}/5.5/$3
    $FILE build ${SHOPWARE_PROJECT}
    wget -O test_images.zip http://releases.s3.shopware.com/test_images_since_5.1.zip
    unzip test_images.zip
    rm test_images.zip
    ;;
  snap)
    checkParameter
    if [ ! -d "$SNAP_DIR" ]; then
      mkdir "$SNAP_DIR"
    fi
    docker-compose run --rm cli bash -c "mysqldump -h mysql -uroot -proot ${SHOPWARE_PROJECT} > /var/www/html/snapshots/${SHOPWARE_PROJECT}${SNAP_SUFFIX}.sql"
    ;;
  rsnap)
    checkParameter
    if [ ! -f "$SNAP_DIR/${SHOPWARE_PROJECT}${SNAP_SUFFIX}.sql" ]; then
      echo "Snap for shop ${SHOPWARE_PROJECT} does not exists"
      exit 1
    fi
    docker-compose run --rm cli mysql -h mysql -u root -proot -e "CREATE DATABASE IF NOT EXISTS $SHOPWARE_PROJECT"
    docker-compose run --rm cli bash -c "mysql -h mysql -uroot -proot ${SHOPWARE_PROJECT} < /var/www/html/snapshots/${SHOPWARE_PROJECT}${SNAP_SUFFIX}.sql"
    ;;
  apply)
    checkParameter
    applyFixture 
    ;;
  *)
    echo "Usage: $0 {build|drop|test|shell|hooks|config|snippets|snap|rsnap|new-ticket|up|down}"
    ;;
esac
